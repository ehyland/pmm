services:
  # Local NPM registry
  registry:
    build:
      dockerfile: test/e2e/Dockerfile.registry
    environment:
      - APP_UID=${APP_UID}
    volumes:
      - ./test/e2e/verdaccio/config.yml:/app/config.yml
      - ./test/e2e/verdaccio/storage/data:/app/storage/data
    ports:
      - 48733:48733
    command: verdaccio -c config.yml

  # For building and publishing to a local registry
  builder:
    build:
      dockerfile: test/e2e/Dockerfile.builder
    network_mode: service:registry
    environment:
      - LOCAL_NPM_REGISTRY=http://localhost:48733/
    volumes:
      - ./packages/pmm/src:/app/packages/pmm/src

  # NodeJS test environment
  tester:
    build:
      dockerfile: test/e2e/Dockerfile.tester
      args:
        - NODE_TEST_VERSION=${NODE_TEST_VERSION}
    network_mode: service:registry
    environment:
      - LOCAL_NPM_REGISTRY=http://localhost:48733/
    volumes:
      - ./test:/app/test
